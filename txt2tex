#! /usr/bin/perl
#
# This is a Perl script used to convert the Icarus Wing source to latex

my $speaker;
my $counter = 0;

sub insertTOC {

    print q|

\vfill\eject

\thispagestyle{empty}

\centerline{Requirements}
\centerline{for}
\centerline{The Great anti-American Novel}

\begin{verbatim}
|;

    open(ICARUSWING, "<IcarusWing");
    while (<ICARUSWING>) {
	if (/^T / or /^Launch Day/) {
	    s/^.*    //;
	    print unless (/^T / or /^Launch Day/);
	}
    }
    close(ICARUSWING);

    print "\\end{verbatim}\n";
}

sub ProcessLine {

    s/\$/\\\$/;				# quote $

    s/_([\w',!.?;]+)_/{\\it \1}/g;	# convert _ to italics
    s/_/ /g;				# convert interior _ to spaces

    # The speaking character can be indicated by a notation at the
    # beginning of the line or paragraph like "Alister:".  Note
    # if this is the case, or undef $speaker if we're at a blank
    # line (in between paragraphs)

    $speaker=$1 if (/^((\w|-)+):/);
    undef $speaker if (/^$/);
    $counter=0 if (/^$/);

    # Remove speaker indication now that we've processed it.
    s/^(\w+)://;

    # Set text color for material in quotes according to speaker
    # Actual colors are defined above in the LaTeX preamble.

    while (/"/ and defined $speaker) {
	if ($counter % 2 == 0) {
	    s/"/\\textcolor{$speaker}{``/;
	} else {
	    s/"/''}/;
	}

	$counter ++;
    }

    # Change '    ' in chapter title lines to hskip
    s/    /\\hskip 0.5in/  if (/^T [+-] [0-9]+/);

    # Put chapter titles on new pages in typewriter font
    #   the centerline is there to make T + 1 day overfill
    s/^T [+-] [0-9]+.*$/\\vfill\\eject\\thispagestyle{empty}\\centerline{\\tt \\hfill $&}\\vskip 0.5in/;

    # Ditto for Launch Day
    s/    /\\hskip 0.5in/  if (/^Launch Day/);
    s/^Launch Day+.*$/\\vfill\\eject\\thispagestyle{empty}{\\tt \\hfill $&}\\vskip 0.5in/;

    # Format poetry at beginning - with italics {{ }}
    s/^{{([^}]*)}}$/\\centerline{\\it \1}/;

    # Format poetry at beginning - without italics {
    s/^{([^}]*)$/\\centerline{\1}/;

    if (/Requirements for The Great anti-American Novel/) {
	&insertTOC;
    } else {
	print;
    }
}

sub ProcessFile {
    my ($FILE) = @_;

    while (<$FILE>) {
	my $filename = $_;
	chomp $filename;

	if (-r $filename) {	    open(NESTED_FILE, "<$filename");
	    ProcessFile(\*NESTED_FILE);
	    close(NESTED_FILE);
	} else {
	    ProcessLine;
	}
    }
}

print q|

\documentclass{book}

\usepackage{vmargin}
\usepackage{times}
\usepackage[pdftex]{color}

\pdfinfo{
  /Title	(Icarus' Wing)
  /Author	(Brent Baccala)
}

\begin{document}

\parindent 0pt
\parskip 12pt

% default seems to be 10/12
\fontsize{12pt}{14pt}
\selectfont

\title{Icarus' Wing}
\author{Brent Baccala}
\date{}

% No title page for e-reader version
% \maketitle

\definecolor{Bible}{rgb}{0.7,0,0}

\definecolor{Mercuriou}{rgb}{0.4,0.2,0}
\definecolor{Burns}{rgb}{0.3,0.3,0}
\definecolor{Vic}{rgb}{0.4,0,0.4}
\definecolor{Alister}{rgb}{0,0.4,0}
\definecolor{Andrea}{rgb}{0,0,0.4}

\definecolor{Kyle}{rgb}{0,0,0}

\definecolor{Ecks}{rgb}{0,0,0}
\definecolor{Wye}{rgb}{0,0,0}
\definecolor{Zee}{rgb}{0,0,0}

\definecolor{Beth}{rgb}{0,0,0}
\definecolor{James}{rgb}{0,0,0}
\definecolor{Jill}{rgb}{0,0,0}

\definecolor{Reginard}{rgb}{0,0,0}
\definecolor{al-Nass}{rgb}{0,0,0}

\frontmatter

\begin{center}
{\Huge Icarus' Wing}
\vskip 0.5in {\Large Brent Baccala}
\end{center}

\mainmatter

|;


ProcessFile(\*STDIN);

print q|
\end{document}
|;
